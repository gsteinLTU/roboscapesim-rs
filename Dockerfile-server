FROM --platform=${BUILDPLATFORM:-linux/amd64} tonistiigi/xx AS xx
FROM --platform=${BUILDPLATFORM:-linux/amd64} rust AS builder

COPY --from=xx / /


ARG BUILDPLATFORM

RUN apt-get update && apt-get install -y clang lld
RUN update-ca-certificates

WORKDIR /roboscape_build
COPY . .
RUN cargo fetch

ARG TARGETPLATFORM
RUN xx-apt-get install -y xx-c-essentials xx-cxx-essentials libssl-dev

WORKDIR /roboscape_build/roboscapesim-server
RUN xx-cargo build --release 

FROM debian:bookworm-slim

RUN apt-get update
RUN apt-get install -y libssl-dev ca-certificates
RUN update-ca-certificates

WORKDIR /roboscape
COPY --from=builder /roboscape_build/target/release/roboscapesim-server .
EXPOSE 3000
CMD [ "./roboscapesim-server" ]
